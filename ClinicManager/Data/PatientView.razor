@page "/patient-edit/{PatientId:int}"
@using ClinicManager.Shared.DTO_s
@using ClinicManager.Data.Modals.Patient
@using ClinicManager.Web.Infrastructure.Services.Patient
@using ClinicManager.Web.Infrastructure.Services.ICDCode
@using ClinicManager.Web.Infrastructure.Services.DayFees
@using Modals
@using ClinicManager.Shared.Wrappers
@inject IPatientService patientService 
@inject IICDCodeService icdCodeService 
@inject IDayFeesService dayFeesService 

<MudGrid>
    <MudItem xs="12" md="12" sm="12">
    <MudButton OnClick="EditPatient" Variant="Variant.Outlined" Color="Color.Info" Style="border-radius:10px 10px 10px 10px">Edit</MudButton>
    </MudItem>
    <MudItem xs="12" md="12" sm="12">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Personal Details">
                <MudGrid>
                    <MudItem xs="6" md="6">
                        <MudTextField Disabled="true" @bind-Value="patient.IDNo" Label="ID Number" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudSelect T="string" @bind-Value="patient.Title" Label="Title" Variant="Variant.Outlined" Disabled="true" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@("Mr")" />
                            <MudSelectItem Value="@("Ms")" />
                            <MudSelectItem Value="@("Miss")" />
                            <MudSelectItem Value="@("Dr")" />
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.FirstName" Label="First Name" Disabled="true" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.LastName" Label="Last Name" Disabled="true" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudDatePicker Date="patient.DateOfBirth" Variant="Variant.Outlined" Disabled="true" Label="Date Of Birth"  />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="Admission Details">
                <MudGrid>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.WardNo" Label="Ward Number" Disabled="true" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.BedNo" Label="Bed Number" Disabled="true" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudDatePicker Date="patient.AdmissionDate" Label="Admission Date" Disabled="true" Variant="Variant.Outlined"/>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudDatePicker Date="patient.DischargeDate" Label="Discharge Date" Disabled="true" Variant="Variant.Outlined"  />
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudDatePicker Date="patient.ReportDate" Label="Report Date" Disabled="true" Variant="Variant.Outlined"  />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="Medical Details">
                <MudGrid>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.RefferingDoctor" Disabled="true" Label="Reffering Doctor" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.RefferingHospital" Disabled="true" Label="Reffering Hospital" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.MedicalAidName" Disabled="true" Label="Medical Aid" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.MedicalAidNo" Disabled="true" Label="Medical Aid Number" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.MedicalAidOption" Disabled="true" Label="Medical Aid Option" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudTextField @bind-Value="patient.DependentCode" Disabled="true" Label="Dependant Code" Variant="Variant.Outlined"></MudTextField>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="OT" @bind-Checked="patient.OT" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="Speech" @bind-Checked="patient.Speech" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="Psychologist" @bind-Checked="patient.Psych" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="Dietician" @bind-Checked="patient.Dietician" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="Social Worker" @bind-Checked="patient.SocialWorker" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                    <MudItem xs="6" md="6">
                        <MudCheckBox Label="Physiotherapist" @bind-Checked="patient.Physio" Disabled="true" Color="Color.Primary"></MudCheckBox>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="ICD Codes">
                <MudGrid>
                    <MudItem xs="12" md="12" sm="12">
                        <MudButton OnClick="AddPatientICDCode" Variant="Variant.Outlined" Color="Color.Info" Style="border-radius:10px 10px 10px 10px">Assign ICD Code</MudButton>
                    </MudItem>
                    @foreach(var icdCode in _patientICDCodes)
                    {               
                    <MudItem xs="2" md="2">
                        <MudCard>
                            <MudCardContent>
                                <MudText Align="Align.Center">@icdCode.ICDCode</MudText> <br />
                                <MudText Align="Align.Center">@icdCode.ICDCodeDescription</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    }

                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Day Fees">
                <MudGrid>
                     <MudItem xs="12" md="12" sm="12">
                        <MudButton OnClick="AddPatientDayFee" Variant="Variant.Outlined" Color="Color.Info" Style="border-radius:10px 10px 10px 10px">Assign Day Fee</MudButton>
                    </MudItem>
                    @foreach(var dayFee in _patientDayFees)
                    {
                    <MudItem xs="2" md="2">
                        <MudCard>
                            <MudCardContent>
                                <MudText Align="Align.Center">@dayFee.DayFeeCode</MudText> <br />
                                <MudText Align="Align.Center">@dayFee.DayFeeDescription</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    }
                </MudGrid>
            </MudTabPanel>

       @*     <MudTabPanel Text="Patient Infections">
                <MudGrid>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>NAD</MudText>
                                <MudChip Color="Color.Success">P</MudChip>
                                <MudChip Color="Color.Error">N</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Class="mr-2" Color="Color.Info">CRP</MudButton>
                                <MudButton Class="mr-2" Color="Color.Warning">WBC</MudButton>
                                <MudButton Class="mr-2" Color="Color.Secondary">Medication</MudButton>
                                <MudButton Color="Color.Tertiary">Follow Up</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>E-Coli, Pseudomonas</MudText>
                                <MudChip Color="Color.Success">P</MudChip>
                                <MudChip Color="Color.Error">N</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Class="mr-2" Color="Color.Info">CRP</MudButton>
                                <MudButton Class="mr-2" Color="Color.Warning">WBC</MudButton>
                                <MudButton Class="mr-2" Color="Color.Secondary">Medication</MudButton>
                                <MudButton Color="Color.Tertiary">Follow Up</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>NAD</MudText>
                                <MudChip Color="Color.Success">P</MudChip>
                                <MudChip Color="Color.Error">N</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Class="mr-2" Color="Color.Info">CRP</MudButton>
                                <MudButton Class="mr-2" Color="Color.Warning">WBC</MudButton>
                                <MudButton Class="mr-2" Color="Color.Secondary">Medication</MudButton>
                                <MudButton Color="Color.Tertiary">Follow Up</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>*@

@*            <MudTabPanel Text="History">
                <MudGrid>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudChip Color="Color.Success">@admission.ToString("MMMM dd")</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <center>
                                    <MudButton Class="mr-2" Color="Color.Info">Upload</MudButton>
                                </center>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudChip Color="Color.Success">@admission.ToString("MMMM dd")</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <center>
                                    <MudButton Class="mr-2" Color="Color.Info">Upload</MudButton>
                                </center>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="4" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudChip Color="Color.Success">@admission.ToString("MMMM dd")</MudChip>
                            </MudCardContent>
                            <MudCardActions>
                                <center>
                                    <MudButton Class="mr-2" Color="Color.Info">Upload</MudButton>
                                </center>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>*@

            <MudTabPanel Text="Emergency Contact">
                <MudGrid>
                   
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </MudItem>
</MudGrid>

@code {
    public PatientDTO patient = new();
    private List<PatientICDCodeDTO> _patientICDCodes = new();
    private List<PatientDayFeeDTO> _patientDayFees = new();

    [Parameter] public int PatientId { get; set; }

    protected async override Task OnInitializedAsync()
    {
        await GetPatientId(PatientId);
        await GetAllPatientICDCodes(PatientId);
        await GetAllPatientDayFees(PatientId);
    }

    public async Task GetPatientId(int patientId)
    {
        IResult<PatientDTO> response;
        var viewPatient = await patientService.GetById(patientId);
        if (viewPatient.Succeeded)
        {
            patient = viewPatient.Data;
        }
    }

    public async Task GetAllPatientICDCodes(int patientId)
    {
        var icdCodes = await icdCodeService.GetAllPatientICDCodes(patientId);
        if (icdCodes.Succeeded)
        {
            _patientICDCodes = icdCodes.Data;
        }
    }

      public async Task GetAllPatientDayFees(int patientId)
    {
        var dayFees = await dayFeesService.GetAllPatientDayFees(patientId);
        if (dayFees.Succeeded)
        {
            _patientDayFees = dayFees.Data;
        }
    }

     private void EditPatient()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(AddEditPatient.AddEditPatientModel), new PatientDTO
        {
            Id = patient.Id,
            AccountNo = patient.AccountNo,
            AdmissionDate = patient.AdmissionDate,
            BedNo = patient.BedNo,
            WardNo = patient.WardNo,
            DateOfBirth = patient.DateOfBirth,
            DependentCode = patient.DependentCode,
            Dietician = patient.Dietician,
            DischargeDate = patient.DischargeDate,
            FirstName = patient.FirstName,
            LastName = patient.LastName,
            Gender = patient.Gender,
            AuthNo = patient.AuthNo,
            CaseInformationNumber = patient.CaseInformationNumber,
            City = patient.City,
            Email = patient.Email,
            EmployerName = patient.EmployerName,
            Initials = patient.Initials,           
            Race = patient.Race,
            Language = patient.Language,
            MainMedicalAidMemberBusinessCity = patient.MainMedicalAidMemberBusinessCity,
            MainMedicalAidMemberBusinessPostalCode = patient.MainMedicalAidMemberBusinessPostalCode,
            MainMedicalAidMemberBusinessProvince = patient.MainMedicalAidMemberBusinessProvince,
            MainMedicalAidMemberBusinessStreetAddress = patient.MainMedicalAidMemberStreetAddress,
            MainMedicalAidMemberCellNo = patient.MainMedicalAidMemberCellNo,
            MainMedicalAidMemberCity = patient.MainMedicalAidMemberCity,
            MainMedicalAidMemberEmployer = patient.MainMedicalAidMemberEmployer,
            MainMedicalAidMemberFirstName = patient.MainMedicalAidMemberFirstName,
            MainMedicalAidMemberLastName = patient.MainMedicalAidMemberLastName,
            MainMedicalAidMemberIdNumber = patient.MainMedicalAidMemberIdNumber,
            MainMedicalAidMemberOccupation = patient.MainMedicalAidMemberOccupation,
            MainMedicalAidMemberPostalAddress = patient.MainMedicalAidMemberPostalAddress,
            MainMedicalAidMemberPostalAddressCode = patient.MainMedicalAidMemberPostalAddressCode,
            MainMedicalAidMemberProvince = patient.MainMedicalAidMemberProvince,
            MainMedicalAidMemberRelationship = patient.MainMedicalAidMemberRelationship,
            MainMedicalAidMemberStreetAddress = patient.MainMedicalAidMemberStreetAddress,
            MainMedicalAidMemberSuburb = patient.MainMedicalAidMemberSuburb,
            MainMedicalAidMemberTelNo = patient.MainMedicalAidMemberTelNo,
            NextOfKin = patient.NextOfKin,
            NextOfKinAltContactNo = patient.NextOfKinAltContactNo,
            NextOfKinContactNo = patient.NextOfKinContactNo,
            Occupation = patient.Occupation,
            OtherContact = patient.OtherContact,
            OtherContactNo = patient.OtherContactNo,
            OtherContactAltContactNo = patient.OtherContactAltContactNo,
            OtherContactRelationship = patient.OtherContactRelationship,
            PatientCellNo = patient.PatientCellNo,
            PatientTelNo = patient.PatientTelNo,
            PatientWorkTelNo = patient.PatientWorkTelNo,
            PoBox = patient.PoBox,
            PoBoxCode = patient.PoBoxCode,
            PostalCode = patient.PostalCode,
            Province = patient.Province,
            RelationshipOfKin = patient.RelationshipOfKin,
            StreetAddress = patient.StreetAddress,
            Suburb = patient.Suburb,
            WorkAddress = patient.WorkAddress,
            WorkAddressCity = patient.WorkAddressCity,
            WorkAddressCode = patient.WorkAddressCode,
            WorkAddressProvince = patient.WorkAddressProvince,
            WoundLocation = patient.WoundLocation,
            MedicalAidName = patient.MedicalAidName,
            MedicalAidNo = patient.MedicalAidNo,
            MedicalAidOption = patient.MedicalAidOption,
            IDNo = patient.IDNo,
            OT = patient.OT,
            Speech = patient.Speech,
            Physio = patient.Physio,
            Psych = patient.Psych,
            RefferingDoctor = patient.RefferingDoctor,
            RefferingHospital = patient.RefferingHospital,
            Relationship = patient.Relationship,
            Title = patient.Title,
            ReportDate = patient.ReportDate,
            SocialWorker = patient.SocialWorker,
            Stage = patient.Stage
        });
        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraLarge, };
        _dialogService.Show<AddEditPatient>("Patient Details", parameters, options);
    }

    private void AddPatientICDCode()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(AssignICDCodePatient.AssignICDCode), new PatientICDCodeDTO
        {
            PatientId = PatientId
        });
        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraExtraLarge, };
        _dialogService.Show<AssignICDCodePatient>("Patient ICD Code", parameters, options);
    }

    private void AddPatientDayFee()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(AssignDayFeesPatient.AssignDayFee), new PatientDayFeeDTO
        {
            PatientId = PatientId
        });
        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraExtraLarge, };
        _dialogService.Show<AssignDayFeesPatient>("Patient Day Fee", parameters, options);
    }
}