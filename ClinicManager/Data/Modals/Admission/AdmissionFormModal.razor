@using Blazored.FluentValidation
@using ClinicManager.Shared.Wrappers
@using ClinicManager.Web.Infrastructure.Services.Admission
@using ClinicManager.Shared.DTO_s
@inject IAdmissionService admissionService 

<MudDialog>
    <DialogContent>
    <EditForm Model="@AddEditAdmissionModel" OnValidSubmit="SaveAsync">
        <MudExpansionPanels Style="width: 700px; overflow: scroll;">
            <MudExpansionPanel Icon="@Icons.TwoTone.Report" Text="Admission">
                <MudItem sm="12">
                    <MudTextField Variant="Variant.Outlined" Disabled="true" T="int" For="@(() => AddEditAdmissionModel.CaseInformationNumber)" 
                        @bind-Value="AddEditAdmissionModel.CaseInformationNumber" 
                        Label="Case Information Number" />
                </MudItem>
                   <MudItem sm="12">
                    <MudTextField Variant="Variant.Outlined" Disabled="true" T="int" For="@(() => AddEditAdmissionModel.AccountNo)" 
                        @bind-Value="AddEditAdmissionModel.AccountNo" 
                        Label="Account Number" />
                </MudItem>
                <MudItem sm="12">
                    <MudDatePicker 
                        MinDate="DateTime.Today" Variant="Variant.Outlined" @bind-Date="admissionDate" Label="Admission Date" />
                </MudItem>
                <MudItem sm="12">
                    <MudTimePicker                      
                        AmPm="true" Label="Admission Time" Variant="Variant.Outlined" @bind-Time="time" Editable="true" />
                </MudItem>
            </MudExpansionPanel>
            <MudExpansionPanel Icon="@Icons.TwoTone.PersonPin" Text="Patient Personal Detail">
                <MudItem sm="12">
                    <MudSelect T="string" Label="Title" @bind-Value="AddEditAdmissionModel.Title" 
                    Variant="Variant.Outlined"
                    AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mr")" />
                        <MudSelectItem T="string" Value="@("Mrs")" />
                        <MudSelectItem T="string" Value="@("Ms")" />
                        <MudSelectItem T="string" Value="@("Miss")" />
                        <MudSelectItem T="string" Value="@("Dr")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.Initials)"  
                        @bind-Value="AddEditAdmissionModel.Initials" 
                    Label="Initials" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.LastName)"  
                        @bind-Value="AddEditAdmissionModel.LastName" 
                        Label="Surname" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.PatientFullName)"  
                        @bind-Value="AddEditAdmissionModel.PatientFullName"
                        Label="Full Names" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.IDNo)"  
                        @bind-Value="AddEditAdmissionModel.IDNo"
                        Label="ID Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudDatePicker 
                        Label="Date of Birth" Variant="Variant.Outlined" @bind-Date="date"/>
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Phone" Text="Contact Details">
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.HomeTelNo)"  
                        @bind-Value="AddEditAdmissionModel.HomeTelNo"
                        Label="Home Telephone" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.CellNo)"  
                        @bind-Value="AddEditAdmissionModel.CellNo"
                        Label="Cellphone Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.WorkTelNo)"  
                        @bind-Value="AddEditAdmissionModel.WorkTelNo"
                        Label="Work Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.Email)"  
                        @bind-Value="AddEditAdmissionModel.Email"
                        Label="Email" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.HomeAddress)"  
                        @bind-Value="AddEditAdmissionModel.HomeAddress"
                        Label="Home Address" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.HomePostalCode)"  
                        @bind-Value="AddEditAdmissionModel.HomePostalCode"
                        Label="Postal Code" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.ListAlt" Text="Other Details">
                <MudItem sm="12">
                    <MudPaper>
                        <MudTextField T="string" For="@(() => AddEditAdmissionModel.POBox)"  
                        @bind-Value="AddEditAdmissionModel.POBox"
                        Label="PO Box" Variant="Variant.Outlined" />
                    </MudPaper>
                </MudItem>
                <MudItem sm="12">
                    <MudPaper>
                        <MudTextField T="int" For="@(() => AddEditAdmissionModel.POBoxCode)"  
                        @bind-Value="AddEditAdmissionModel.POBoxCode"
                        Label="PO Box Code" Variant="Variant.Outlined" />
                    </MudPaper>
                </MudItem>
                <MudItem sm="12">
                    <MudPaper>
                        <MudTextField T="string" For="@(() => AddEditAdmissionModel.Occupation)"  
                        @bind-Value="AddEditAdmissionModel.Occupation"
                        Label="Occupation" Variant="Variant.Outlined" />
                    </MudPaper>
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Language" @bind-Value="AddEditAdmissionModel.Language" 
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("English")" />
                        <MudSelectItem T="string" Value="@("Afrikaans")" />
                        <MudSelectItem T="string" Value="@("Setswana")" />
                        <MudSelectItem T="string" Value="@("isiZulu")" />
                        <MudSelectItem T="string" Value="@("Sesotho")" />
                        <MudSelectItem T="string" Value="@("Sepedi")" />
                        <MudSelectItem T="string" Value="@("isiNdebele")" />
                        <MudSelectItem T="string" Value="@("isiXhosa")" />
                        <MudSelectItem T="string" Value="@("siSwati")" />
                        <MudSelectItem T="string" Value="@("Tshivenda")" />
                        <MudSelectItem T="string" Value="@("Xitsonga")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Gender" @bind-Value="AddEditAdmissionModel.Gender" 
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Male")" />
                        <MudSelectItem T="string" Value="@("Female")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Race" @bind-Value="AddEditAdmissionModel.Race"  
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Black")" />
                        <MudSelectItem T="string" Value="@("White")" />
                        <MudSelectItem T="string" Value="@("Coloured")" />
                        <MudSelectItem T="string" Value="@("Indian")" />
                        <MudSelectItem T="string" Value="@("Asian")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.EmployerName)"  
                        @bind-Value="AddEditAdmissionModel.EmployerName"
                        Label="Employer Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.WorkAddress)"  
                        @bind-Value="AddEditAdmissionModel.WorkAddress"
                        Label="Work Address" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.WorkAddressPostalCode)"  
                        @bind-Value="AddEditAdmissionModel.WorkAddressPostalCode"
                        Label="Work Postal Code" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>
            <MudExpansionPanel Icon="@Icons.TwoTone.PersonOutline" Text="Family Details">
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.NextOfKin)"  
                        @bind-Value="AddEditAdmissionModel.NextOfKin"
                        Label="Next Of Kin" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.ContactNoKin)"  
                        @bind-Value="AddEditAdmissionModel.ContactNoKin"
                        Label="Contact Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Relationship" @bind-Value="AddEditAdmissionModel.RelationshipOfKin"
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mother")" />
                        <MudSelectItem T="string" Value="@("Father")" />
                        <MudSelectItem T="string" Value="@("Brother")" />
                        <MudSelectItem T="string" Value="@("Sister")" />
                        <MudSelectItem T="string" Value="@("Spouse")" />
                        <MudSelectItem T="string" Value="@("Cousin")" />
                        <MudSelectItem T="string" Value="@("Partner")" />
                        <MudSelectItem T="string" Value="@("Grandparent")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.AltContactNoKin)"  
                        @bind-Value="AddEditAdmissionModel.AltContactNoKin"
                        Label="Alternative Contact Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.OtherContact)"  
                        @bind-Value="AddEditAdmissionModel.OtherContact"
                        Label="Other Contact" Variant="Variant.Outlined" />
                </MudItem>
                 <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.OtherContactNo)"  
                        @bind-Value="AddEditAdmissionModel.OtherContactNo"
                        Label="Alternative Contact Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Relationship" @bind-Value="AddEditAdmissionModel.OtherContactRelationship"
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mother")" />
                        <MudSelectItem T="string" Value="@("Father")" />
                        <MudSelectItem T="string" Value="@("Brother")" />
                        <MudSelectItem T="string" Value="@("Sister")" />
                        <MudSelectItem T="string" Value="@("Spouse")" />
                        <MudSelectItem T="string" Value="@("Cousin")" />
                        <MudSelectItem T="string" Value="@("Partner")" />
                        <MudSelectItem T="string" Value="@("Grandparent")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.OtherContactNoAlt)"  
                        @bind-Value="AddEditAdmissionModel.OtherContactNoAlt"
                        Label="Other Contact Number" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>
            
              <MudExpansionPanel Icon="@Icons.TwoTone.MedicalServices" Text="Medical Aid Details">
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidName)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidName"
                        Label="Medical Aid Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidOption)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidOption"
                        Label="Option" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidNo)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidNo"
                        Label="Medical Aid Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.AuthNo)"  
                        @bind-Value="AddEditAdmissionModel.AuthNo"
                        Label="Authentication Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.DependentCode)"  
                        @bind-Value="AddEditAdmissionModel.DependentCode"
                        Label="Dependent Code" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Person" Text="Accountable Person Details">
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberFullName)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberFullName"
                        Label="Full Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int " For="@(() => AddEditAdmissionModel.MedicalAidMemberIdNo)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberIdNo"
                        Label="ID Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Relationship" @bind-Value="AddEditAdmissionModel.MedicalAidMemberRelationship"
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mother")" />
                        <MudSelectItem T="string" Value="@("Father")" />
                        <MudSelectItem T="string" Value="@("Brother")" />
                        <MudSelectItem T="string" Value="@("Sister")" />
                        <MudSelectItem T="string" Value="@("Spouse")" />
                        <MudSelectItem T="string" Value="@("Cousin")" />
                        <MudSelectItem T="string" Value="@("Partner")" />
                        <MudSelectItem T="string" Value="@("Grandparent")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.MedicalAidMemberTelNo)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberTelNo"
                        Label="Telephone Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="int" For="@(() => AddEditAdmissionModel.MedicalAidMemberCellNo)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberCellNo"
                        Label="Cellphone Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberPostalAddress)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberPostalAddress"
                        Label="Postal Address" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberPostalAddressCode)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberPostalAddressCode"
                        Label="Postal Code" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberHomeAddress)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberHomeAddress"
                        Label="Home Address" Variant="Variant.Outlined" />
                </MudItem>
                 <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberHomePostalCode)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberHomePostalCode"
                        Label="Home Postal Code" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberOccupation)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberOccupation"
                        Label="Occupation" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>
            <MudExpansionPanel Icon="@Icons.TwoTone.BusinessCenter" Text="Business Details">
  
                  <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberEmployerName)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberEmployerName"
                        Label="Employer Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberBusinessAddress)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberBusinessAddress"
                        Label="Business Address" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" For="@(() => AddEditAdmissionModel.MedicalAidMemberBusinessPostalCode)"  
                        @bind-Value="AddEditAdmissionModel.MedicalAidMemberBusinessPostalCode"
                        Label="Business Postal Code" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton DisableElevation Variant="Variant.Filled" OnClick="Cancel">Cancel</MudButton>
        <MudButton DisableElevation Variant="Variant.Filled" ButtonType="ButtonType.Submit" Disabled="@(_processing)" OnClick="SaveAsync"  Color="Color.Success">
            @if (_processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Processing</MudText>
            }
            else
            {
                <MudText>Admit Patient</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public AdmissionDTO AddEditAdmissionModel { get; set; } = new();
    private bool _processing = false;
    DateTime? admissionDate = DateTime.Today;
    DateTime? date = DateTime.Today;
    TimeSpan? time = new TimeSpan(00, 00, 00);

    public void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task SaveAsync()
    {
        _processing = true;
        IResult<int> response;
        date = AddEditAdmissionModel.DateOfBirth;
        admissionDate = AddEditAdmissionModel.AdmissionDate;

        if (AddEditAdmissionModel.AdmissionId == 0)
            response = await admissionService.SaveAsync(AddEditAdmissionModel);
        else
            response = await admissionService.UpdateAsync(AddEditAdmissionModel);

        if (response.Succeeded)
        {
            if (AddEditAdmissionModel.AdmissionId == 0)
            {
                _snackBar.Add("Patient Admitted", Severity.Success);
                _processing = false;
            }
            else
            {
                _snackBar.Add("Admission Updated", Severity.Success);
                _processing = false;
            }
            MudDialog.Close();
        }
        else
        {
            foreach (var message in response.Messages)
            {
                _snackBar.Add(message, Severity.Error);
            }
        }
    }     
}