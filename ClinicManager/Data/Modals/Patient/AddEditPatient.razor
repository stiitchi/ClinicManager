@using Blazored.FluentValidation
@using ClinicManager.Web.Infrastructure.Services.Patient
@using ClinicManager.Web.Infrastructure.Services.Ward
@using ClinicManager.Web.Infrastructure.Services.Bed
@using ClinicManager.Shared.Wrappers
@using ClinicManager.Shared.DTO_s
@inject IPatientService patientService 
@inject IWardService wardService 
@inject IBedService bedService 

<MudDialog>
    <DialogContent>
    <EditForm Model="@AddEditPatientModel">
        <MudExpansionPanels Style="width: 700px; overflow: scroll;">
            <MudExpansionPanel  Icon="@Icons.Filled.Check" HideIcon="_admissionDone"  Text="Admission">
                 <MudItem sm="12">
                    <MudTextField Variant="Variant.Outlined" Disabled="true" @bind-Value="AddEditPatientModel.AccountNo" Label="Account Number" />
                </MudItem>
                <MudSelect ToStringFunc="@(i=>_wards.FirstOrDefault(o=>o.Id == i)?.Prop2 ?? string.Empty)" Variant="Variant.Outlined" ValueChanged="GetAllBedsByWardId"
                    Label="Ward Number" T="int">
                @foreach (var item in _wards)
                {
                    <MudSelectItem T="int" Value="@item.Id" />
                }
                </MudSelect>
                <MudSelect ToStringFunc="@(i=>_beds.FirstOrDefault(o=>o.Id == i)?.Name ?? string.Empty)" @bind-Value="AddEditPatientModel.BedNo" Variant="Variant.Outlined"
                    Label="Bed Number" T="int">
                @foreach (var item in _beds)
                {
                    <MudSelectItem T="int" Value="@item.Id" />
                }
                </MudSelect>
                <MudItem sm="12">
                    <MudDatePicker MinDate="DateTime.Today" Variant="Variant.Outlined" @bind-Date="AddEditPatientModel.AdmissionDate" Label="Admission Date" />
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Check" HideIcon="_personalDone" Text="Patient Personal Detail">
                <MudItem sm="12">
                    <MudSelect T="string" Label="Title" @bind-Value="AddEditPatientModel.Title" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mr")" />
                        <MudSelectItem T="string" Value="@("Mrs")" />
                        <MudSelectItem T="string" Value="@("Ms")" />
                        <MudSelectItem T="string" Value="@("Miss")" />
                        <MudSelectItem T="string" Value="@("Dr")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.FirstName"  Label="First Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.LastName" Label="Last Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudDatePicker Variant="Variant.Outlined" @bind-Date="AddEditPatientModel.DateOfBirth" Label="Date of Birth" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField Variant="Variant.Outlined"  @bind-Value="AddEditPatientModel.IDNo"  Label="ID Number" />
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Check" HideIcon="_medicalDone" Text="Medical Details">
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.RefferingDoctor" Label="Reffering Doctor" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.RefferingHospital" Label="Reffering Hospital" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.MedicalAidName" Label="Medical Aid Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.MedicalAidNo" Label="Medical Aid Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.MedicalAidOption" Label="Medical Aid  Option" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.DependentCode" Label="Dependent Code" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="OT" @bind-Checked="AddEditPatientModel.OT" Color="Color.Primary"></MudCheckBox>
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="Speech" @bind-Checked="AddEditPatientModel.Speech" Color="Color.Primary"></MudCheckBox>
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="Psychologist" @bind-Checked="AddEditPatientModel.Psych" Color="Color.Primary"></MudCheckBox>
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="Dietician" @bind-Checked="AddEditPatientModel.Dietician" Color="Color.Primary"></MudCheckBox>
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="Social Worker" @bind-Checked="AddEditPatientModel.SocialWorker" Color="Color.Primary"></MudCheckBox>
                </MudItem>
                <MudItem sm="6">
                    <MudCheckBox Label="Physiotherapist" @bind-Checked="AddEditPatientModel.Physio" Color="Color.Primary"></MudCheckBox>
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Check" HideIcon="_otherDone" Text="Other Details">
                <MudItem sm="12">
                    <MudSelect T="string" Label="Language" @bind-Value="AddEditPatientModel.Language" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("English")" />
                        <MudSelectItem T="string" Value="@("Afrikaans")" />
                        <MudSelectItem T="string" Value="@("Setswana")" />
                        <MudSelectItem T="string" Value="@("isiZulu")" />
                        <MudSelectItem T="string" Value="@("Sesotho")" />
                        <MudSelectItem T="string" Value="@("Sepedi")" />
                        <MudSelectItem T="string" Value="@("isiNdebele")" />
                        <MudSelectItem T="string" Value="@("isiXhosa")" />
                        <MudSelectItem T="string" Value="@("siSwati")" />
                        <MudSelectItem T="string" Value="@("Tshivenda")" />
                        <MudSelectItem T="string" Value="@("Xitsonga")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Gender" Variant="Variant.Outlined" @bind-Value="AddEditPatientModel.Gender" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Male")" />
                        <MudSelectItem T="string" Value="@("Female")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Race" @bind-Value="AddEditPatientModel.Race" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("White")" />
                        <MudSelectItem T="string" Value="@("Black")" />
                        <MudSelectItem T="string" Value="@("Coloured")" />
                        <MudSelectItem T="string" Value="@("Indian")" />
                        <MudSelectItem T="string" Value="@("Asian")" />
                    </MudSelect>
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Check" HideIcon="_emergencyDone"  Text="Emergency Details">
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.EmergencyContactFirstName" Label="First Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.EmergencyContactLastName" Label="Last Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.EmergencyContactIdNo" Label="ID Number" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudSelect T="string" Label="Relationship" Variant="Variant.Outlined" @bind-Value="AddEditPatientModel.Relationship" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("Mother")" />
                        <MudSelectItem T="string" Value="@("Father")" />
                        <MudSelectItem T="string" Value="@("Brother")" />
                        <MudSelectItem T="string" Value="@("Sister")" />
                        <MudSelectItem T="string" Value="@("Spouse")" />
                        <MudSelectItem T="string" Value="@("Cousin")" />
                        <MudSelectItem T="string" Value="@("Partner")" />
                        <MudSelectItem T="string" Value="@("Grandparent")" />
                        <MudSelectItem T="string" Value="@("Other")" />
                    </MudSelect>
                </MudItem>
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.EmergencyContactNo" Label="Contact Number" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>

            <MudExpansionPanel Icon="@Icons.TwoTone.Check" HideIcon="_woundCareDone" Text="Wound Care">
                <MudItem sm="12">
                    <MudTextField @bind-Value="AddEditPatientModel.Location" Label="Location" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem sm="12">
                    <MudTextField T="string" Label="Stage" ValueChanged="LastValue" Variant="Variant.Outlined" />
                </MudItem>
            </MudExpansionPanel>
        </MudExpansionPanels>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" Style="border-radius:10px 10px 10px 10px"
                   Color="Color.Error" OnClick="Cancel">Cancel</MudButton>
        <MudButton DisableElevation Variant="Variant.Outlined" OnClick="SaveAsync"
        ButtonType="ButtonType.Submit" Disabled="@(_processing || _lastEntry)" 
        Style="border-radius:10px 10px 10px 10px"
        Color="Color.Success">
            @if (AddEditPatientModel.Id != 0)
            {
                <MudText>Edit Patient</MudText>
            }
            else
            {
                <MudText>Add Patient</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public PatientDTO AddEditPatientModel { get; set; } = new();
    [Parameter] public PatientBedDTO AddEditPatientBedModel { get; set; } = new();
    //private FluentValidationValidator _fluentValidationValidator;
    //private bool Validated => _fluentValidationValidator.Validate(options => { options.IncludeAllRuleSets(); });

    private List<LookupDTO> _wards = new();
    private List<LookupDTO> _beds = new();
    public int PatientBedId { get; set; }

    private bool _admissionDone = true;
    private bool _personalDone = true;
    private bool _medicalDone = true;
    private bool _otherDone = true;
    private bool _emergencyDone = true;
    private bool _woundCareDone = true;

    private bool _processing = false;
    private bool _lastEntry = true;
    private DateTime? dischargeDate = DateTime.Now;
    private DateTime? reportDate = DateTime.Now;

    protected async override Task OnInitializedAsync()
    {
        await GetForLookup();
    }

    public void Cancel()
    {
        MudDialog.Cancel();
    }

    public async Task LastValue(string stage)
    {
        AddEditPatientModel.Stage = stage;
        if(AddEditPatientModel.Stage != null)
        {      
            _lastEntry = false;
        }
    }

    private async Task SaveAsync()
    {
        _processing = true;
        IResult<int> response;

        AddEditPatientModel.ReportDate = DateTime.Now;
        AddEditPatientModel.DischargeDate = DateTime.Now;

    

        if(AddEditPatientModel.IDNo != 0 && AddEditPatientModel.WardNo != 0 && AddEditPatientModel.BedNo != 0 && AddEditPatientModel.AdmissionDate != null)
        {
            _admissionDone = false;
        }
        if(AddEditPatientModel.Title != null && AddEditPatientModel.FirstName != null && AddEditPatientModel.LastName != null && AddEditPatientModel.DateOfBirth != null)
        {
            _personalDone = false;
        }
        if(AddEditPatientModel.RefferingDoctor != null && AddEditPatientModel.RefferingHospital != null && AddEditPatientModel.MedicalAidName != null && 
           AddEditPatientModel.MedicalAidNo != 0 && AddEditPatientModel.MedicalAidOption != null && AddEditPatientModel.DependentCode != null)
        {
            _medicalDone = false;
        }
        if(AddEditPatientModel.Language != null && AddEditPatientModel.Gender != null && AddEditPatientModel.Race != null)
        {
            _otherDone = false;
        }
        if(AddEditPatientModel.EmergencyContactFirstName != null && AddEditPatientModel.EmergencyContactLastName != null && AddEditPatientModel.EmergencyContactIdNo != 0
        && AddEditPatientModel.Relationship != null && AddEditPatientModel.EmergencyContactNo != 0)
        {
            _emergencyDone = false;
        }
        if(AddEditPatientModel.Stage != null && AddEditPatientModel.Location != null)
        {
            _woundCareDone = false;
        }

        if (AddEditPatientModel.Id == 0)
            response = await patientService.SaveAsync(AddEditPatientModel);
        else
            response = await patientService.UpdateAsync(AddEditPatientModel);

        if (response.Succeeded)
        {
            if (AddEditPatientModel.Id == 0)
            {
                _snackBar.Add("Patient Added", Severity.Success);
                _processing = false;
                _navigationManager.NavigateTo("/patients");
            }
            else
            {
                _snackBar.Add("Patient Updated", Severity.Success);
                _navigationManager.NavigateTo($"/patient-edit/{AddEditPatientModel.Id}", true);
                _processing = false;
            }
            MudDialog.Close();
        }
        else
        {
            foreach (var message in response.Messages)
            {
                _snackBar.Add(message, Severity.Error);
            }
        }
    }  

    public async Task GetForLookup()
    {
        var wards = await wardService.GetForLookUp();
        if (wards.Succeeded)
        {
            _wards = wards.Data;
        }
    }

    public async Task GetAllBedsByWardId(int wardId)
    {
        AddEditPatientModel.WardNo = wardId;
        var bed = await bedService.BedsByWardIdLookup(wardId);
        if (bed.Succeeded)
        {
            _beds = bed.Data;
        }
    }
}